---
title: "R Notebook"
output: html_notebook
editor_options: 
  chunk_output_type: inline
---

```{r}
library(ggrepel)

```

```{r Get count matrix}
cts = read.csv('../../data/tagSeqOuts/star_salmon/salmon.merged.gene_counts_length_scaled.tsv', sep = '\t', row.names = 1)
cts = cts[,2:ncol(cts)]
cts = round(cts)

colKeep436 = c("G1.MB435BST2lo",  "G2.MB435BST2lo",  "G3.MB435BST2lo",  "H1.MB435BST2hi",  "H2.MB435BST2hi",  "H3.MB435BST2hi")
colKeep231 = c("C1.MB231ESAMneg", "C2.MB231ESAMneg",  "C3.MB231ESAMneg", "D1.MB231ESAMpos", "D2.MB231ESAMpos", "D3.MB231ESAMpos")
colKeep = c(colKeep436, colKeep231)
cts = cts[,colKeep]

cts231 = cts[,colKeep231]
cts436 = cts[,colKeep436]

dfGenes436 = read.csv('../../data/topGenes436.csv', row.names = 1)
dfGenes231 = read.csv('../../data/topGenes231.csv', row.names = 1)
```

```{r Generate DE Genes}
conditions = c('low', 'low', 'low', 'high', 'high', 'high')
types = rep('paired-end', 6)
coldata231 = data.frame(condition = conditions, type = types)
row.names(coldata231) = colnames(cts231)

coldata436 = data.frame(condition = conditions, type = types)
row.names(coldata436) = colnames(cts436)

dds231 <- DESeqDataSetFromMatrix(countData = cts231,
                              colData = coldata231,
                              design = ~ condition)
dds231 <- DESeq(dds231)
res231 <- results(dds231, contrast = c('condition', 'high', 'low'))

dds436 <- DESeqDataSetFromMatrix(countData = cts436,
                              colData = coldata436,
                              design = ~ condition)
dds436 <- DESeq(dds436)
res436 <- results(dds436, contrast = c('condition', 'high', 'low'))
```

```{r}
nTopGenes = 200
nLower = dim(dfGenes436)[1]-nTopGenes+1
highGenes = dfGenes436$names[1:nTopGenes]
lowGenes = dfGenes436$names[nLower:dim(dfGenes436)[1]]
topGenes436 = c(highGenes, lowGenes)

norm436 = data.frame(counts(dds436, normalized = TRUE))
top436 = norm436[topGenes436,]
# top436 =cts436[c('BST2', 'ESAM'),]
top436 = top436[complete.cases(top436),]
top436 = top436[rowSums(top436) > 0,]

# Reverse order of samples such that it's BST2High and then low 
# top436 = rev(top436)

acceptedSingleCell = dfGenes436[dfGenes436$names %in% row.names(top436),]

nLow = sum(acceptedSingleCell$score > 0)
nHigh = sum(acceptedSingleCell$score < 0)

labelRows = data.frame(group = as.factor(c(rep('BST2 Low', nLow), rep('BST2 High', nHigh))))

colnames(labelRows) = 'Subpopulation'
rownames(labelRows) = rownames(top436)


labelCols = data.frame(group = as.factor(c(rep('BST2 High', 3), rep('BST2 Low', 3))))
rownames(labelCols) = colnames(top436)

matColors = list(Subpopulation = c('BST2 High' = '#44B1BB', 'BST2 Low' = '#BB4E44'))

# matColors = list(Subpopulation = c('1' = '#44B1BB', '2' = '#BB4E44'))
p = pheatmap(
              top436, 
              scale = 'row',
              treeheight_row = 0, 
              treeheight_col = 15,
              # annotation_col = labelCols,
              annotation_row = labelRows,
              annotation_legend = FALSE, 
              annotation_colors = matColors,
              annotation_names_row = FALSE,
              annotation_names_col = FALSE,
              drop_levels = TRUE,
              cluster_rows = FALSE,
              # legend = FALSE,
              labels_row = rep('',dim(top436)[1]),
              labels_col = rep('',dim(top436)[2]),
              angle_col = 0
)
scaling = 2

ggsave('../../figures/final/436TagSeqHeatmap.png',
       p,
       dpi = 900,
       height = 2.4*scaling,
       width = 2.2*scaling)
```

```{r}
nTopGenes = 200
nLower = dim(dfGenes231)[1]-nTopGenes+1
highGenes = dfGenes231$names[1:nTopGenes]
lowGenes = dfGenes231$names[nLower:dim(dfGenes231)[1]]
topGenes231 = c(highGenes, lowGenes)

norm231 = data.frame(counts(dds231, normalized = TRUE))
top231 = norm231[topGenes231,]
# top231 =cts231[c('BST2', 'ESAM'),]
top231 = top231[complete.cases(top231),]
top231 = top231[rowSums(top231) > 0,]

acceptedSingleCell = dfGenes231[dfGenes231$names %in% row.names(top231),]
# Reverse order of samples such that it's BST2High and then low 
# top231 = rev(top231)

nLow = sum(acceptedSingleCell$score > 0)
nHigh = sum(acceptedSingleCell$score < 0)

labelRows = data.frame(group = as.factor(c(rep('ESAM Low', nLow), rep('ESAM High', nHigh))))

colnames(labelRows) = 'Subpopulation'
rownames(labelRows) = rownames(top231)

labelCols = data.frame(group = as.factor(c(rep('ESAM High', 3), rep('ESAM Low', 3))))
rownames(labelCols) = colnames(top231)

matColors = list(Subpopulation = c('ESAM High' = '#44B1BB', 'ESAM Low' = '#BB4E44'))

# matColors = list(Subpopulation = c('1' = '#44B1BB', '2' = '#BB4E44'))
p = pheatmap(
              top231, 
              scale = 'row',
              treeheight_row = 0, 
              treeheight_col = 15,
              # annotation_col = labelCols,
              annotation_row = labelRows,
              annotation_legend = FALSE, 
              annotation_colors = matColors,
              annotation_names_row = FALSE,
              annotation_names_col = FALSE,
              drop_levels = TRUE,
              cluster_rows = FALSE,
              # legend = FALSE,
              labels_row = rep('',dim(top231)[1]),
              labels_col = rep('',dim(top231)[2]),
              angle_col = 0
)
scaling = 2

ggsave('../../figures/final/231TagSeqHeatmap.png',
       p,
       dpi = 900,
       height = 2.4*scaling,
       width = 2.2*scaling)

```

```{r}

emdGenes = read.csv('../../data/optimalGenes/allEMDGenesNewOld.csv', row.names = 1)
emdGenes436 = emdGenes[emdGenes$cellLine == 'mdamb436',]
emdGenes231 = emdGenes[emdGenes$cellLine == 'mdamb231',]

topEMD436 = emdGenes436$genes[0:10]
topEMD231 = emdGenes231$genes[0:10]
head(emdGenes436)

row.names(emdGenes436) = seq(1, dim(emdGenes436)[1])
row.names(emdGenes231) = seq(1, dim(emdGenes231)[1])

emdGenes436 = emdGenes436[,2:3]
emdGenes231 = emdGenes231[,2:3]

colnames(emdGenes436) = c('genes', 'score')
colnames(emdGenes231) = c('genes', 'score')

write.csv(emdGenes436, '../../data/emdGenesRankScore436.csv')
write.csv(emdGenes231, '../../data/emdGenesRankScore231.csv')

```

```{r}
# plot_DE_volcano_genelist <- function(res, title, padj_threshold = 0.05, abs_l2fc_min = 1, colrs=c('red','forestgreen'))
padj = 0.05
l2fc = 1
res = data.frame(res231)
cols = c('#BB4E44', '#44B1BB')
plotVolc <- res %>% select(log2FoldChange, pvalue, padj) %>% rownames_to_column('gene')
plotVolc = plotVolc[complete.cases(plotVolc),]
sigDown = plotVolc$log2FoldChange < -l2fc & plotVolc$padj < padj
sigUp   = plotVolc$log2FoldChange >  l2fc & plotVolc$padj < padj
plotVolc$color = 'NA'
plotVolc$color[sigDown] = 'down'
plotVolc$color[sigUp] = 'up'
cols = c('NA' = 'gray', 'down' = cols[1], 'up' = cols[2])
plotVolc$geneLabel = ''
plotVolc$geneLabel[plotVolc$gene %in% topEMD231] = plotVolc$gene[plotVolc$gene %in% topEMD231]

xticks = round(seq(min(plotVolc$log2FoldChange), max(plotVolc$log2FoldChange)))
p = ggplot(plotVolc, aes(x = log2FoldChange, y = -log10(padj), label = geneLabel))+
  geom_point(aes(color = factor(color)), size = 0.4)+
  scale_color_manual(values = cols)+
  geom_vline(xintercept = c(-l2fc,l2fc), linewidth=0.1, linetype='dashed') +
  geom_hline(yintercept = c(-log10(padj)), linewidth=0.1, linetype='dashed') +
  scale_x_continuous(breaks = xticks) + 
  theme_few()+
  geom_text_repel(max.overlaps = Inf, max.iter = 10000, min.segment.length = 0, force = 200, size = 2, segment.size=.25, bg.color = 'white')+
  labs(title = '') + 
  theme(legend.position = "none", text = element_text(size = 10))
print(p)
ggsave('../../figures/final/231VolcanoPlot.png', p, dpi = 500, width = 3.3, height = 1.9)

```

```{r}
padj = 0.05
l2fc = 1
res = data.frame(res436)
cols = c('#BB4E44', '#44B1BB')
plotVolc <- res %>% select(log2FoldChange, pvalue, padj) %>% rownames_to_column('gene')
plotVolc = plotVolc[complete.cases(plotVolc),]
sigDown = plotVolc$log2FoldChange < -l2fc & plotVolc$padj < padj
sigUp   = plotVolc$log2FoldChange >  l2fc & plotVolc$padj < padj
plotVolc$color = 'NA'
plotVolc$color[sigDown] = 'down'
plotVolc$color[sigUp] = 'up'
cols = c('NA' = 'gray', 'down' = cols[1], 'up' = cols[2])
plotVolc$geneLabel = ''
plotVolc$geneLabel[plotVolc$gene %in% topEMD436] = plotVolc$gene[plotVolc$gene %in% topEMD436]

xticks = round(seq(min(plotVolc$log2FoldChange), max(plotVolc$log2FoldChange)))
p = ggplot(plotVolc, aes(x = log2FoldChange, y = -log10(padj), label = geneLabel))+
  geom_point(aes(color = factor(color)), size = 0.4)+
  scale_color_manual(values = cols)+
  geom_vline(xintercept = c(-l2fc,l2fc), linewidth=0.1, linetype='dashed') +
  geom_hline(yintercept = c(-log10(padj)), linewidth=0.1, linetype='dashed') +
  scale_x_continuous(breaks = xticks) + 
  theme_few()+
  geom_text_repel(max.overlaps = Inf, max.iter = 10000, min.segment.length = 0, force = 200, size = 2, segment.size=.25, bg.color = 'white')+
  labs(title = '') + 
  theme(legend.position = "none", text = element_text(size = 10))

ggsave('../../figures/final/436VolcanoPlot.png',  p, dpi = 500, width = 3.3, height = 1.9)

```

```{r}

```
